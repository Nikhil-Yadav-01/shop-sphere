version: '3.8'

services:
  # PostgreSQL for Auth Service
  auth-db:
    image: postgres:15-alpine
    container_name: auth-db
    environment:
      POSTGRES_DB: shopsphere_auth
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Admin Service
  admin-db:
    image: postgres:15-alpine
    container_name: admin-db
    environment:
      POSTGRES_DB: shopsphere_admin
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5434:5432"
    volumes:
      - admin-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Discovery Service (Eureka)
  discovery-service:
    build:
      context: .
      dockerfile: discovery-service/Dockerfile
    container_name: discovery-service
    ports:
      - "8761:8761"
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    environment:
      DB_HOST: auth-db
      DB_PORT: 5432
      DB_NAME: shopsphere_auth
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      JWT_SECRET: mySecretKeyForJWTTokenGenerationMustBeAtLeast256BitsLong
      JWT_EXPIRATION_MS: 3600000
      JWT_REFRESH_EXPIRATION_MS: 604800000
    ports:
      - "8081:8081"
    depends_on:
      auth-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Admin Service
  admin-service:
    build:
      context: .
      dockerfile: admin-service/Dockerfile
    container_name: admin-service
    environment:
      DB_HOST: admin-db
      DB_PORT: 5432
      DB_NAME: shopsphere_admin
      DB_USER: postgres
      DB_PASSWORD: password
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      SERVER_PORT: 8089
    ports:
      - "8089:8089"
    depends_on:
      admin-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/admin/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    environment:
      EUREKA_URI: http://discovery-service:8761/eureka
      AUTH_SERVICE_URL: http://auth-service:8081
    ports:
      - "8080:8080"
    depends_on:
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      admin-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Kafka (KRaft mode - no Zookeeper)
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    environment:
      KAFKA_NODE_ID: 0
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 1
    ports:
      - "9092:9092"
      - "9093:9093"
      - "9094:9094"
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # MongoDB for Analytics Service
  analytics-db:
    image: mongo:7.0
    container_name: analytics-db
    ports:
      - "27017:27017"
    volumes:
      - analytics-db-data:/data/db
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB for Catalog Service
  catalog-db:
    image: mongo:7.0
    container_name: catalog-db
    ports:
      - "27018:27017"
    volumes:
      - catalog-db-data:/data/db
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Analytics Service
  analytics-service:
    build:
      context: .
      dockerfile: analytics-service/Dockerfile
    container_name: analytics-service
    environment:
      MONGO_URI: mongodb://analytics-db:27017/shopsphere_analytics
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "8090:8090"
    depends_on:
      analytics-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/analytics/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Batch Service
  batch-service:
    build:
      context: .
      dockerfile: batch-service/Dockerfile
    container_name: batch-service
    environment:
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
    ports:
      - "8091:8091"
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Catalog Service
  catalog-service:
    build:
      context: .
      dockerfile: catalog-service/Dockerfile
    container_name: catalog-service
    environment:
      MONGO_URI: mongodb://catalog-db:27017/shopsphere_catalog
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "8083:8083"
    depends_on:
      catalog-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Redis for Cart Service
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Cart Service
  cart-service:
    build:
      context: .
      dockerfile: cart-service/Dockerfile
    container_name: cart-service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
      - "8085:8085"
    depends_on:
      redis:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL for Checkout Service
  checkout-db:
    image: postgres:15-alpine
    container_name: checkout-db
    environment:
      POSTGRES_DB: shopsphere_checkout
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5435:5432"
    volumes:
      - checkout-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Coupon Service
  coupon-db:
    image: postgres:15-alpine
    container_name: coupon-db
    environment:
      POSTGRES_DB: coupon_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5436:5432"
    volumes:
      - coupon-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Pricing Service
  pricing-db:
    image: postgres:15-alpine
    container_name: pricing-db
    environment:
      POSTGRES_DB: pricing_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5437:5432"
    volumes:
      - pricing-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Order Service
  order-db:
    image: postgres:15-alpine
    container_name: order-db
    environment:
      POSTGRES_DB: shopsphere_order
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5438:5432"
    volumes:
      - order-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Checkout Service
  checkout-service:
    build:
      context: .
      dockerfile: checkout-service/Dockerfile
    container_name: checkout-service
    environment:
      DB_HOST: checkout-db
      DB_PORT: 5432
      DB_NAME: shopsphere_checkout
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      PAYMENT_PROVIDER: mock
      PAYMENT_API_KEY: mock-api-key
    ports:
      - "8086:8086"
    depends_on:
      checkout-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      cart-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Coupon Service
  coupon-service:
    build:
      context: .
      dockerfile: coupon-service/Dockerfile
    container_name: coupon-service
    environment:
      DB_HOST: coupon-db
      DB_PORT: 5432
      DB_NAME: coupon_db
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
      - "8088:8088"
    depends_on:
      coupon-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Pricing Service
  pricing-service:
    build:
      context: .
      dockerfile: pricing-service/Dockerfile
    container_name: pricing-service
    environment:
      DB_HOST: pricing-db
      DB_PORT: 5432
      DB_NAME: pricing_db
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
      - "8087:8087"
    depends_on:
      pricing-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Order Service
  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    container_name: order-service
    environment:
      DB_HOST: order-db
      DB_PORT: 5432
      DB_NAME: shopsphere_order
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8084
    ports:
      - "8084:8084"
    depends_on:
      order-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL for Inventory Service
  inventory-db:
    image: postgres:15-alpine
    container_name: inventory-db
    environment:
      POSTGRES_DB: shopsphere_inventory
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5440:5432"
    volumes:
      - inventory-db-data:/var/lib/postgresql/data
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Inventory Service
  inventory-service:
    build:
      context: .
      dockerfile: inventory-service/Dockerfile
    container_name: inventory-service
    environment:
      DB_HOST: inventory-db
      DB_PORT: 5432
      DB_NAME: shopsphere_inventory
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8092
    ports:
      - "8092:8092"
    depends_on:
      inventory-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - shopsphere-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  shopsphere-network:
    driver: bridge

volumes:
  auth-db-data:
  admin-db-data:
  analytics-db-data:
  catalog-db-data:
  checkout-db-data:
  coupon-db-data:
  pricing-db-data:
  order-db-data:
  inventory-db-data:
