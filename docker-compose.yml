version: '3.8'
services:
  auth-db:
    image: postgres:15-alpine
    container_name: auth-db
    environment:
      POSTGRES_DB: shopsphere_auth
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5433:5432
    volumes:
    - auth-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  admin-db:
    image: postgres:15-alpine
    container_name: admin-db
    environment:
      POSTGRES_DB: shopsphere_admin
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5434:5432
    volumes:
    - admin-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  discovery-service:
    build:
      context: .
      dockerfile: discovery-service/Dockerfile
    container_name: discovery-service
    ports:
    - 8761:8761
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8761/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    container_name: auth-service
    environment:
      DB_HOST: auth-db
      DB_PORT: 5432
      DB_NAME: shopsphere_auth
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      JWT_SECRET: mySecretKeyForJWTTokenGenerationMustBeAtLeast256BitsLong
      JWT_EXPIRATION_MS: 3600000
      JWT_REFRESH_EXPIRATION_MS: 604800000
    ports:
    - 8081:8081
    depends_on:
      auth-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8081/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  user-service:
    build:
      context: .
      dockerfile: user-service/Dockerfile
    container_name: user-service
    environment:
      DB_HOST: user-db
      DB_PORT: 5432
      DB_NAME: shopsphere_users
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
    - 8082:8082
    depends_on:
      user-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8082/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  media-db:
    image: postgres:15-alpine
    container_name: media-db
    environment:
      POSTGRES_DB: shopsphere_media
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5435:5432
    volumes:
    - media-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  admin-service:
    build:
      context: .
      dockerfile: admin-service/Dockerfile
    container_name: admin-service
    environment:
      DB_HOST: admin-db
      DB_PORT: 5432
      DB_NAME: shopsphere_admin
      DB_USER: postgres
      DB_PASSWORD: password
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      SERVER_PORT: 8089
    ports:
    - 8089:8089
    depends_on:
      admin-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8089/admin/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    environment:
      EUREKA_URI: http://discovery-service:8761/eureka
      AUTH_SERVICE_URL: http://auth-service:8081
    ports:
    - 8080:8080
    depends_on:
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      admin-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8080/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    environment:
      KAFKA_NODE_ID: 0
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 1
    ports:
    - 9092:9092
    - 9093:9093
    - 9094:9094
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092
        || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
  analytics-db:
    image: mongo:7.0
    container_name: analytics-db
    ports:
    - 27017:27017
    volumes:
    - analytics-db-data:/data/db
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - mongosh
      - --eval
      - db.adminCommand('ping')
      interval: 10s
      timeout: 5s
      retries: 5
  catalog-db:
    image: mongo:7.0
    container_name: catalog-db
    ports:
    - 27018:27017
    volumes:
    - catalog-db-data:/data/db
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - mongosh
      - --eval
      - db.adminCommand('ping')
      interval: 10s
      timeout: 5s
      retries: 5
  analytics-service:
    build:
      context: .
      dockerfile: analytics-service/Dockerfile
    container_name: analytics-service
    environment:
      MONGO_URI: mongodb://analytics-db:27017/shopsphere_analytics
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
    - 8090:8090
    depends_on:
      analytics-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8090/analytics/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  media-service:
    build:
      context: .
      dockerfile: media-service/Dockerfile
    container_name: media-service
    environment:
      DB_HOST: media-db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: password
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MEDIA_UPLOAD_DIR: /app/uploads
    ports:
    - 8091:8091
    depends_on:
      media-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    volumes:
    - media-uploads:/app/uploads
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8091/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  batch-service:
    build:
      context: .
      dockerfile: batch-service/Dockerfile
    container_name: batch-service
    environment:
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
    ports:
    - 8091:8091
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8091/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  catalog-service:
    build:
      context: .
      dockerfile: catalog-service/Dockerfile
    container_name: catalog-service
    environment:
      MONGO_URI: mongodb://catalog-db:27017/shopsphere_catalog
      EUREKA_HOST: discovery-service
      EUREKA_PORT: 8761
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
    - 8083:8083
    depends_on:
      catalog-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8083/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
    - 6379:6379
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
  cart-service:
    build:
      context: .
      dockerfile: cart-service/Dockerfile
    container_name: cart-service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
    - 8085:8085
    depends_on:
      redis:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8085/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  checkout-db:
    image: postgres:15-alpine
    container_name: checkout-db
    environment:
      POSTGRES_DB: shopsphere_checkout
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5435:5432
    volumes:
    - checkout-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  coupon-db:
    image: postgres:15-alpine
    container_name: coupon-db
    environment:
      POSTGRES_DB: coupon_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5436:5432
    volumes:
    - coupon-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  pricing-db:
    image: postgres:15-alpine
    container_name: pricing-db
    environment:
      POSTGRES_DB: pricing_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5437:5432
    volumes:
    - pricing-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  order-db:
    image: postgres:15-alpine
    container_name: order-db
    environment:
      POSTGRES_DB: shopsphere_order
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5438:5432
    volumes:
    - order-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  payment-db:
    image: postgres:15-alpine
    container_name: payment-db
    environment:
      POSTGRES_DB: shopsphere_payment
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5439:5432
    volumes:
    - payment-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  notification-db:
    image: postgres:15-alpine
    container_name: notification-db
    environment:
      POSTGRES_DB: shopsphere_notification
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5442:5432
    volumes:
    - notification-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  inventory-db:
    image: postgres:15-alpine
    container_name: inventory-db
    environment:
      POSTGRES_DB: shopsphere_inventory
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5440:5432
    volumes:
    - inventory-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  fraud-db:
    image: postgres:15-alpine
    container_name: fraud-db
    environment:
      POSTGRES_DB: shopsphere_fraud
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5441:5432
    volumes:
    - fraud-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  checkout-service:
    build:
      context: .
      dockerfile: checkout-service/Dockerfile
    container_name: checkout-service
    environment:
      DB_HOST: checkout-db
      DB_PORT: 5432
      DB_NAME: shopsphere_checkout
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      PAYMENT_PROVIDER: mock
      PAYMENT_API_KEY: mock-api-key
    ports:
    - 8086:8086
    depends_on:
      checkout-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      cart-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8086/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  coupon-service:
    build:
      context: .
      dockerfile: coupon-service/Dockerfile
    container_name: coupon-service
    environment:
      DB_HOST: coupon-db
      DB_PORT: 5432
      DB_NAME: coupon_db
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
    - 8088:8088
    depends_on:
      coupon-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8088/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  pricing-service:
    build:
      context: .
      dockerfile: pricing-service/Dockerfile
    container_name: pricing-service
    environment:
      DB_HOST: pricing-db
      DB_PORT: 5432
      DB_NAME: pricing_db
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
    ports:
    - 8087:8087
    depends_on:
      pricing-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8087/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  order-service:
    build:
      context: .
      dockerfile: order-service/Dockerfile
    container_name: order-service
    environment:
      DB_HOST: order-db
      DB_PORT: 5432
      DB_NAME: shopsphere_order
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8084
    ports:
    - 8084:8084
    depends_on:
      order-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8084/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  payment-service:
    build:
      context: .
      dockerfile: payment-service/Dockerfile
    container_name: payment-service
    environment:
      DB_HOST: payment-db
      DB_PORT: 5432
      POSTGRES_DB: shopsphere_payment
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8093
    ports:
    - 8093:8093
    depends_on:
      payment-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8093/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  inventory-service:
    build:
      context: .
      dockerfile: inventory-service/Dockerfile
    container_name: inventory-service
    environment:
      DB_HOST: inventory-db
      DB_PORT: 5432
      DB_NAME: shopsphere_inventory
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8092
    ports:
    - 8092:8092
    depends_on:
      inventory-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8092/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  fraud-service:
    build:
      context: .
      dockerfile: fraud-service/Dockerfile
    container_name: fraud-service
    environment:
      DB_HOST: fraud-db
      DB_PORT: 5432
      DB_NAME: shopsphere_fraud
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8010
    ports:
    - 8010:8010
    depends_on:
      fraud-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8010/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    environment:
      DB_HOST: notification-db
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: password
      EUREKA_URI: http://discovery-service:8761/eureka
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8095
    ports:
    - 8095:8095
    depends_on:
      notification-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8095/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  user-db:
    image: postgres:15-alpine
    container_name: user-db
    environment:
      POSTGRES_DB: shopsphere_users
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
    - 5444:5432
    volumes:
    - user-db-data:/var/lib/postgresql/data
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
  review-db:
    image: mongo:7.0
    container_name: review-db
    ports:
    - 27019:27017
    volumes:
    - review-db-data:/data/db
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - mongosh
      - --eval
      - db.adminCommand('ping')
      interval: 10s
      timeout: 5s
      retries: 5
  review-service:
    build:
      context: .
      dockerfile: review-service/Dockerfile
    container_name: review-service
    environment:
      MONGO_URI: mongodb://review-db:27017/shopsphere_review
      EUREKA_HOST: discovery-service
      EUREKA_PORT: '8761'
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
    - 8089:8089
    depends_on:
      review-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
    - shopsphere-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8089/actuator/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
networks:
  shopsphere-network:
    driver: bridge
volumes:
  auth-db-data: null
  admin-db-data: null
  analytics-db-data: null
  catalog-db-data: null
  checkout-db-data: null
  coupon-db-data: null
  pricing-db-data: null
  order-db-data: null
  payment-db-data: null
  inventory-db-data: null
  fraud-db-data: null
  notification-db-data: null
  media-db-data: null
  media-uploads: null
  kafka-data: null
  user-db-data: null
  review-db-data: null
