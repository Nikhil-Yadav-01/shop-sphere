server:
  port: 8080

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: false
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URI:http://localhost:8761/eureka}
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true

auth:
  service:
    url: ${AUTH_SERVICE_URL:http://localhost:8081}
  request:
    timeout: ${AUTH_REQUEST_TIMEOUT:5000}

jwt:
  secret: ${JWT_SECRET:your-secret-key-change-in-production}

rate-limiting:
  requests-per-minute: ${RATE_LIMIT_RPM:100}

cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:*}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS,PATCH}
  allowed-headers: ${CORS_ALLOWED_HEADERS:*}
  exposed-headers: X-Correlation-ID,X-Trace-ID,X-Rate-Limit-Remaining,X-Rate-Limit-Reset
  max-age: ${CORS_MAX_AGE:3600}
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}

gateway:
  max-content-length: ${GATEWAY_MAX_CONTENT_LENGTH:10485760}
  request:
    timeout: ${GATEWAY_REQUEST_TIMEOUT:30000}
  ip-filter-enabled: ${IP_FILTER_ENABLED:false}
  ip-whitelist: ${IP_WHITELIST:}
  ip-blacklist: ${IP_BLACKLIST:}
  # Per-service timeout configuration (ms)
  service-timeouts:
    auth-service: 5000        # 5s for auth (quick)
    catalog-service: 10000    # 10s for catalog (read-heavy)
    cart-service: 8000        # 8s
    order-service: 12000      # 12s (might do async work)
    user-service: 8000        # 8s
    search-service: 15000     # 15s (can be slow with large datasets)
    review-service: 10000     # 10s
    pricing-service: 8000     # 8s
    recommendation-service: 15000  # 15s (ML recommendations)
    notification-service: 10000    # 10s
    returns-service: 10000    # 10s
    checkout-service: 15000   # 15s (complex processing)
    admin-service: 10000      # 10s
    media-service: 20000      # 20s (large file uploads)

csrf:
  protection-enabled: ${CSRF_PROTECTION_ENABLED:true}

mtls:
  enabled: ${MTLS_ENABLED:false}
  keyStorePath: ${MTLS_KEYSTORE_PATH:}
  keyStorePassword: ${MTLS_KEYSTORE_PASSWORD:}
  trustStorePath: ${MTLS_TRUSTSTORE_PATH:}
  trustStorePassword: ${MTLS_TRUSTSTORE_PASSWORD:}
  routes:
    # Auth Service - Public routes
    - name: auth-service
      path: /auth/**
      uri: lb://auth-service
      authenticated: false
      stripPrefix: false

    # Catalog Service - Public READ routes only
    - name: catalog-service-read
      path: /catalog/**
      uri: lb://catalog-service
      authenticated: false
      stripPrefix: true
      # Note: Only GET requests handled here (configured in routing logic)
      # POST/PUT/DELETE require authentication (see catalog-service-write below)

    # Catalog Service - Protected WRITE routes
    - name: catalog-service-write
      path: /catalog/**
      uri: lb://catalog-service
      authenticated: true
      stripPrefix: true
      roles:
        - ADMIN
        - SELLER

    # Admin Service - Protected routes
    - name: admin-service
      path: /admin/**
      uri: lb://admin-service
      authenticated: true
      stripPrefix: false
      roles:
        - ADMIN

    # Cart Service - Public routes
    - name: cart-service
      path: /cart/**
      uri: lb://cart-service
      authenticated: false
      stripPrefix: true

    # Checkout Service - Protected routes
    - name: checkout-service
      path: /checkout/**
      uri: lb://checkout-service
      authenticated: true
      stripPrefix: true

    # Order Service - Protected routes
    - name: order-service
      path: /order/**
      uri: lb://order-service
      authenticated: true
      stripPrefix: true

    # Pricing Service - Public routes
    - name: pricing-service
      path: /pricing/**
      uri: lb://pricing-service
      authenticated: false
      stripPrefix: true

    # User Service - Protected routes
    - name: user-service
      path: /user/**
      uri: lb://user-service
      authenticated: true
      stripPrefix: true

    # Review Service - Public routes (read), protected (write)
    - name: review-service
      path: /review/**
      uri: lb://review-service
      authenticated: false
      stripPrefix: true

    # Search Service - Public routes
    - name: search-service
      path: /search/**
      uri: lb://search-service
      authenticated: false
      stripPrefix: true

    # Recommendation Service - Public routes
    - name: recommendation-service
      path: /recommendation/**
      uri: lb://recommendation-service
      authenticated: false
      stripPrefix: true

    # Notification Service - Protected routes
    - name: notification-service
      path: /notification/**
      uri: lb://notification-service
      authenticated: true
      stripPrefix: true

    # Returns Service - Protected routes
    - name: returns-service
      path: /returns/**
      uri: lb://returns-service
      authenticated: true
      stripPrefix: true

    # Media Service - Public routes (read), protected (write)
    - name: media-service
      path: /media/**
      uri: lb://media-service
      authenticated: false
      stripPrefix: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,routes,metrics,prometheus
  endpoint:
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    com.rudraksha.shopsphere.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.server: DEBUG
  pattern:
    console: "[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] %-5level %logger{36} - %msg%n"

resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        failureRateThreshold: 50
        slowCallRateThreshold: 50
        waitDurationInOpenState: 30000
        slowCallDurationThreshold: 5000
        permittedNumberOfCallsInHalfOpenState: 3
        minimumNumberOfCalls: 10
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      auth-service:
        baseConfig: default
      catalog-service:
        baseConfig: default
